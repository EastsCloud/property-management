
{% extends 'en/base.html' %}
{% block content %}
<h4>New Payment</h4>
<form method="post" class="row g-3">
  <div class="col-md-4">
    <label class="form-label">Owner</label>
    <select name="owner_id" class="form-select" required>
      {% for o in owners %}<option value="{{ o.id }}">{{ o.name }} ({{ o.unit }})</option>{% endfor %}
    </select>
  </div>
  <div class="col-md-4">
    <label class="form-label">Invoice (optional)</label>
    <select name="invoice_id" id="invoice_id" class="form-select" onchange="updateInvoiceInfo()">
      <option value="">--</option>
      {% for i in invoices %}
        <option value="{{ i.id }}" 
                data-amount="{{ i.amount }}" 
                data-paid="{{ invoice_paid.get(i.id, 0) }}"
                data-unpaid="{{ i.unpaid_amount or i.amount }}">
          #{{ i.id }} {{ i.owner.name }} Total ¥{{ i.amount }} Due {{ i.due_date }}
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-4">
    <label class="form-label">Invoice Info</label>
    <div id="invoice_info" class="form-control bg-light" style="padding: 0.375rem 0.75rem; min-height: 38px; display: flex; align-items: center;">
      <small class="text-muted">Select invoice to view details</small>
    </div>
  </div>
  <div class="col-md-4"><label class="form-label">Amount</label><input name="amount" type="number" step="0.01" class="form-control" required></div>
  <div class="col-md-4"><label class="form-label">Method</label>
    <select name="method" class="form-select">
      <option value="线上">Online</option>
      <option value="线下">Offline</option>
      <option value="现金">Cash</option>
      <option value="银行转账">Bank Transfer</option>
    </select>
  </div>
  <div class="col-md-4"><label class="form-label">Note</label><input name="note" class="form-control"></div>
  <div class="col-12">
    <button class="btn btn-primary">Save</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('payments_list') }}">Cancel</a>
  </div>
</form>

<script>
function updateInvoiceInfo() {
  const select = document.getElementById('invoice_id');
  const infoDiv = document.getElementById('invoice_info');
  const selectedOption = select.options[select.selectedIndex];
  
  if (selectedOption.value) {
    const total = parseFloat(selectedOption.dataset.amount) || 0;
    const paid = parseFloat(selectedOption.dataset.paid) || 0;
    const unpaid = parseFloat(selectedOption.dataset.unpaid) || 0;
    
    infoDiv.innerHTML = `
      <small>
        <strong>Total:</strong> ¥${total.toFixed(2)} | 
        <strong>Paid:</strong> ¥${paid.toFixed(2)} | 
        <strong>Remaining:</strong> ¥${unpaid.toFixed(2)}
      </small>
    `;
  } else {
    infoDiv.innerHTML = '<small class="text-muted">Select invoice to view details</small>';
  }
}
</script>
{% endblock %}

