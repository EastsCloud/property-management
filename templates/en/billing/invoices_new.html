
{% extends 'en/base.html' %}
{% block content %}
<h4>New Invoice</h4>
<form method="post" class="row g-3">
  <div class="col-md-4">
    <label class="form-label">Owner</label>
    <select name="owner_id" id="owner_id" class="form-select" required>
      {% for o in owners %}<option value="{{ o.id }}" data-area="{{ o.area or 0 }}" data-vehicles="{{ o.vehicle_count or 0 }}">{{ o.name }} ({{ o.unit }})</option>{% endfor %}
    </select>
  </div>
  <div class="col-md-4">
    <label class="form-label">Charge Type</label>
    <select name="charge_type_id" id="charge_type_id" class="form-select" required>
      {% for t in types %}<option value="{{ t.id }}" data-price="{{ t.price }}" data-cycle="{{ t.billing_cycle or '月' }}">{{ t.name }}</option>{% endfor %}
    </select>
  </div>
  <div class="col-md-4">
    <label class="form-label">Billing Cycle</label>
    <input name="billing_cycle" id="billing_cycle" class="form-control" readonly>
  </div>
  <div class="col-md-4"><label class="form-label">Unit Price</label><input type="number" step="0.01" name="price" id="price" class="form-control" required placeholder="Auto from charge type"></div>
  <div class="col-md-4"><label class="form-label">Amount (Month)</label><input type="number" step="0.01" name="amount" id="amount" class="form-control" readonly></div>
  <div class="col-md-4"><label class="form-label">Related Info</label>
    <input type="text" id="related_info" class="form-control" readonly placeholder="Auto-linked to owner info">
  </div>
  <div class="col-md-3"><label class="form-label">Due Date</label><input type="date" name="due_date" class="form-control" required></div>
  <div class="col-md-12"><label class="form-label">Note</label><input name="description" class="form-control"></div>
  <div class="col-12"><button class="btn btn-primary">Save</button></div>
</form>
<script>
document.getElementById('owner_id').addEventListener('change', calculateAmount);
document.getElementById('charge_type_id').addEventListener('change', calculateAmount);
document.getElementById('price').addEventListener('input', calculateAmount);

function calculateAmount() {
  const ownerSelect = document.getElementById('owner_id');
  const typeSelect = document.getElementById('charge_type_id');
  const priceInput = document.getElementById('price');
  const amountInput = document.getElementById('amount');
  const cycleInput = document.getElementById('billing_cycle');
  const relatedInfoInput = document.getElementById('related_info');
  
  const selectedOwner = ownerSelect.options[ownerSelect.selectedIndex];
  const selectedType = typeSelect.options[typeSelect.selectedIndex];
  const typeName = selectedType.text.toLowerCase();
  
  // Set billing cycle
  cycleInput.value = selectedType.dataset.cycle || '月';
  
  // Auto set unit price (from charge type, but can be modified)
  priceInput.value = selectedType.dataset.price || 0;
  
  // Calculate quantity and show related info
  let quantity = 0;
  let relatedInfo = '';
  if (typeName.includes('物业') || typeName.includes('property')) {
    quantity = parseFloat(selectedOwner.dataset.area) || 0;
    relatedInfo = `Area: ${quantity}㎡`;
  } else if (typeName.includes('停车') || typeName.includes('parking')) {
    quantity = parseFloat(selectedOwner.dataset.vehicles) || 0;
    relatedInfo = `Vehicles: ${quantity}`;
  } else {
    quantity = 1;
    relatedInfo = 'Other type';
  }
  relatedInfoInput.value = relatedInfo;
  
  // Calculate amount
  const price = parseFloat(priceInput.value) || 0;
  amountInput.value = (price * quantity).toFixed(2);
}
calculateAmount();
</script>
{% endblock %}


